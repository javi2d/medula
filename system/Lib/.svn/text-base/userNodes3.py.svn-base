




def solve( path ):
	
	
	nbrain = brain.Lib.nodeScript.nodeBrain( path )

	brain.nodeScript( 'byNode' , { } )[ nbrain.name ] = nbrain
	
	bspace = Brain() << nbrain.space
	
	unode_class = bspace( 'Class' , 'NoOp' )

	selected_nodes = nuke.selectedNodes() 
	
	UNODE = nuke.createNode( unode_class , 'name %s' %  nbrain.name , inpanel = False )
	
	if unode_class == 'BackdropNode' and selected_nodes:
	
		minimum = [ min( [ n.xpos() for n in selected_nodes ] ) , min( [ n.ypos() for n in selected_nodes ] ) ]
		maximum = [ max( [ n.xpos() for n in selected_nodes ] ) , max( [ n.ypos() for n in selected_nodes ] ) ]
		
		UNODE.setXYpos( minimum[0]-40 ,  minimum[1]-40 , )
		
		width  = abs( maximum[0] - minimum[0] )
		height = abs( maximum[1] - minimum[1] )
		
		UNODE['bdwidth'].setValue( width + 150 ) 
		UNODE['bdheight'].setValue( height + 120 )
	

	
	this = space.this( UNODE )
	
	if this.CLASS_NBRAIN:
	
		brain.Lib.nodes7.remove_nodeScript_knobs( this )


	all_custom_knobs = brain.Lib.nodes7.user_knobs( this )

	if len( all_custom_knobs ) == 1 and all_custom_knobs[0].Class() == 'Tab_Knob':
	
		UNODE.removeKnob( all_custom_knobs[0] )



	Callbacks = nbrain.system_callbacks.get( 'onUserCreate' , [ ] )
	
	for callback in Callbacks:
		
		callback( this )
		
		
	for knob in [ k for k in nbrain.knobs if k not in '[ ]'.split() ]:
		
		try:
		
			UNODE.addKnob( knob )
		
		except RuntimeError:
			
			print '\n>> UserNode Duplicated Knob %s\n' % knob.name() 
		
		
		if nbrain.knob_callbacks.get( knob.name() , None ) and hasattr( knob , 'setCommand' ):

			knob.setCommand( 'sh.Lib.userNodes3().button_callback( "%s" , "%s" )' % ( nbrain.name , knob.name() )  )
		
	
	id_knob = nuke.String_Knob('userNode_id')
	
	id_knob.setVisible(False)

	id_knob.setValue( nbrain.basename )
	
	UNODE.addKnob( id_knob )

	Callbacks = nbrain.system_callbacks.get( 'onCreate' , [ ] )

	for callback in Callbacks:

		callback( this )
		
	
	
	if this.CLASS_NBRAIN:
	
		brain.Lib.nodes7.add_nodeScript_knobs( this )
	
	
	return UNODE , nbrain
	


def refresh_unode( nbrain_name ):
	
	nbrain = brain.nodeScript.byNode[ nbrain_name ]
	
	nbrain = brain.Lib.nodeScript.nodeBrain( nbrain.path )	
	
	brain.nodeScript.byNode[ nbrain.name ] = nbrain
	
	
	
	
	
def button_callback( nbrain_name , knob_name ):
	
	print '\n\nunode userCallback' , brain.nodeScript.byNode
	
	if brain( 'AUTO_REFRESH_NODE' , False ):
		
		refresh_unode( nbrain_name )
		
		print '&&'
		
	
	knob_callbacks = brain.nodeScript.byNode[ nbrain_name ].knob_callbacks
	
	print knob_callbacks
	
	if knob_name in knob_callbacks:
		
		for callback in knob_callbacks[ knob_name ]:
			
			callback( this() )
		
				
				
				