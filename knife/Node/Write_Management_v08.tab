



class Management:
	
	wm_category  = enumKnob( '' ,  [  ] ) 

	wm_label      = strKnob( '' , 'Untitled_%s' % this.HOSTLABEL , clearflags = 'STARTLINE' )
	
	wm_ext = linkKnob( '' , 'file_type' , clearflags = 'STARTLINE')
	
	wm_colorspace  = linkKnob( '' , 'colorspace' , clearflags = 'STARTLINE')
	
	sep0   = sepKnob( ' ' )
	
	wm_channels    = linkKnob( '' , 'channels'  )
	

	sep1   = sepKnob()

	wm_folderize  = boolKnob( ' in folder' , True , flags = 'STARTLINE') #, flags = 'STARTLINE'
	wm_perversion  = boolKnob( ' per version' , True )
	wm_overwrite  = boolKnob( 'overwrite' , False )
	
	sep2 = sepKnob()
	
	wm_tree     = txtKnob( '' , '----'   )
	
	sep3 = sepKnob()
	
	wm_path_target = enumKnob( 'target'  , ['file' , 'both'] )  #, clearflags = 'STARTLINE' 
	
	wm_refresh = bttnKnob( 'refresh' )
	
	
	
	sep4 = sepKnob()
	
	wm_file_path = linkKnob( 'file' , 'file'  )
	
	wm_proxy_path = linkKnob( 'proxy' , 'proxy' )
	
	
	sep5 = sepKnob( ' ' )
	
	wm_render      = linkKnob( 'render' , 'Render' , flags = 'STARTLINE')
		
	#sep6 = sepKnob( ' ' )
	
	wm_user_path = strKnob( 'user' , '' , flags = 'INVISIBLE' )
	
	wm_auto_rise_version = boolKnob( '' , True , flags = 'INVISIBLE')
	
	#sep7 = sepKnob( ' ' )




def _refresh( this ):
	
	nuke.executeInMainThreadWithResult( this.NODE.hideControlPanel )
	nuke.executeInMainThreadWithResult( this.NODE.showControlPanel )
	
	return



def knobChanged( this ):
	
	if this.KNOB.name() in 'showPanel wm_category wm_label wm_folderize wm_perversion wm_overwrite wm_refresh wm_path_target'.split():

		if not this.VALUES.wm_auto_rise_version:
			
			print 'WARNING !!!! PATH NOT REBUILDED IN WRITE [ %s ] , wm_auto_rise_version is set to False' % this.NODE.name() 
		
		else:

			brain.Lib.mWrites.build_path( this )


		



def onUserCreate( this ):
	
	#print 'Newly created Node'
	pass

def onCreate( this ):

	
	current_value = this.VALUES.wm_category
		
	categories = list(  [ 'disabled' ] + brain.Categories['names']  )
	
	msg = 'In Write.onCreate ( current_value =  %s , categories = %s )' % ( current_value , categories )	
	sys.__stdout__.write( '\n%s\n' % msg )
	
	value_is_digit = str(current_value).isdigit()
	
	if value_is_digit:
		
		this.KNOBS.wm_category.setValues( categories )	
		this.KNOBS.wm_category.setValue( 'disabled' )
	
	
	wm_category( this )
		
	#elif current_value not in categories:
	#	
	#	categories.append( current_value )
	#	
	#	this.KNOBS.wm_category.setValues( categories )
	#	this.KNOBS.wm_category.setValue( current_value )
	#	
    #
	#wm_category( this )
	#
	#if not current_value == 'disabled':
	#
	#	brain.Lib.mWrites.build_path( this )
	
		
	

	#if not str(current_value).isdigit() and current_value not in new_categories:
	#	
	#	new_categories.append( current_value )
	#
	#
	#if not this.KNOBS.wm_category.values() == new_categories:
	#	
	#	this.KNOBS.wm_category.setValues( new_categories )
	#	
	#	wm_category( this )
		
		
	
		


#*************************************************************************************************
# Last edited



def _isEnabled( this ):
	
	return ( False if this.VALUES.wm_category == 'disabled' else True )



def wm_category( this ):
	
	
	if not _isEnabled( this ):

		if this.VALUES.wm_user_path:
    
			this.KNOBS.file.fromScript( this.VALUES.wm_user_path )
			this.KNOBS.wm_user_path.setValue('')
	
	# Enable or Disable 
	
	for name in [ n for n in this.KNOBS['names'] if n.startswith('wm_') and not n == 'wm_category' ]:
    
		knob = this.KNOBS( name )	
		knob.setEnabled( _isEnabled( this ) )
		
	#print 'DEBUG ::: wm_category'
	
	
def file_type( this ):
	
	if this.VALUES.file_type == 'jpeg' and this.VALUES._jpeg_quality == .75 :
		
		this.KNOBS._jpeg_quality.setValue( 1. )
			
	brain.Lib.mWrites.build_path( this )
	
		

def afterRender( this ):

	if not this.VALUES.wm_category == 'disabled' and this.VALUES.wm_auto_rise_version:
		
		print '\nRender Finished , updating file_knobs'
		
		brain.Lib.mWrites.build_path( this )



def autolabel( this ):
	

	if _isEnabled( this ):
		
		label = this.VALUES.wm_category
		color = brain.Categories( '%s.color' % label , 'Aquamarine' )
		
		proxy_mode = this.ROOT.VALUES.proxy #nuke.tcl( 'value root.proxy' )

		filename = this.VALUES.proxy if proxy_mode else this.VALUES.file
		
		if filename:
			
			basename = os.path.basename( filename )
		
		else:
			
			if proxy_mode:
				
				basename = 'NO PROXY OUTPUT'
				
			else:
				
				basename = 'NO RENDER OUTPUT'
		
		asterisk = (  '*' if this.VALUES.wm_overwrite else '' )

		return '<center><font size=3>%s\n<b><font size=6 color= %s>%s%s</font>\n%s</b></font>\n(%s)</center>' % ( this.NODE.name() , color , label , asterisk , basename , this.VALUES.colorspace ) # 

	else:

		return None


